<!-- app/templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio{% block title %}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 (dark mode support) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color:rgb(54, 54, 54);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar, .footer {
            background-color: #1e1e1e;
        }
        .footer {
            margin-top: auto;
            padding: 1rem 0;
        }
        a.nav-link {
            color: #ffffff;
        }
        a.nav-link:hover {
            color: #0d6efd;
        }
        .modal-content {
            background-color:rgb(54, 54, 54);
            color: #f8f9fa;
        }
        .btn-close {
            filter: invert(1);
        }

        /* Override Bootstrap table-dark classes for transparent background */
        .table-dark {
            background-color: transparent !important;
        }

        .table-dark th,
        .table-dark td {
            background-color: transparent !important;
            border-color: #495057;
        }

        .table-dark thead th {
            background-color: transparent !important;
            border-bottom: 3px solid #ffffff;
        }

        .table-dark tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body>

<!-- Token Timeout Modal -->
<div class="modal fade" id="tokenTimeoutModal" tabindex="-1" aria-labelledby="tokenTimeoutModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenTimeoutModalLabel">Session Expiring Soon</h5>
            </div>
            <div class="modal-body">
                <p>Your session will expire in <span id="timeRemaining">60</span> seconds.</p>
                <p>Would you like to extend your session?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelRefresh">Cancel</button>
                <button type="button" class="btn btn-primary" id="refreshToken">OK - Extend Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Alfred Clark Scott</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">Download</a></li>
                <li class="nav-item"><a class="nav-link" href="/about">Homelab</a></li>
                <li class="nav-item"><a class="nav-link" href="/projects">Projects</a></li>
                {% if staff %}
                    <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                {% else %}
                    <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="container my-4">
    {% block content %}
    <br/>
    <br/>
    {% endblock %}
</main>

<!-- Footer -->
<footer class="footer text-center">
    <div class="container">
        <span class="text-muted">Â© {{ year | default(2025) }} My Portfolio</span>
    </div>
</footer>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Token Timeout Handling Script -->
<script>
class TokenTimeoutManager {
    constructor(tokenExpiresInSeconds) {
        this.tokenExpiresIn = tokenExpiresInSeconds;
        this.warningThreshold = 60; // Show warning 1 minute before expiration
        this.countdownInterval = null;
        this.timeoutInterval = null;
        this.modalShown = false;
        this.modal = null;

        this.init();
    }

    init() {
        // Only initialize if we have a valid token expiration time
        if (this.tokenExpiresIn <= 0) {
            console.log('No valid token expiration time, skipping timeout manager');
            return;
        }

        console.log(`Token expires in ${this.tokenExpiresIn} seconds`);

        // Initialize Bootstrap modal
        this.modal = new bootstrap.Modal(document.getElementById('tokenTimeoutModal'));

        // Set up event listeners
        this.setupEventListeners();

        // Calculate when to show warning
        const timeUntilWarning = Math.max(0, this.tokenExpiresIn - this.warningThreshold);

        if (timeUntilWarning > 0) {
            // Set timeout to show warning modal
            this.timeoutInterval = setTimeout(() => {
                this.showWarningModal();
            }, timeUntilWarning * 1000);

            console.log(`Warning will show in ${timeUntilWarning} seconds`);
        } else {
            // Token expires very soon, show warning immediately
            this.showWarningModal();
        }
    }

    setupEventListeners() {
        // Refresh token button
        document.getElementById('refreshToken').addEventListener('click', () => {
            this.refreshToken();
        });

        // Cancel button
        document.getElementById('cancelRefresh').addEventListener('click', () => {
            this.cancelRefresh();
        });
    }

    showWarningModal() {
        if (this.modalShown) return;

        this.modalShown = true;
        console.log('Showing token expiration warning modal');

        // Show the modal
        this.modal.show();

        // Start countdown
        this.startCountdown();
    }

    startCountdown() {
        const timeRemainingSpan = document.getElementById('timeRemaining');
        let remainingSeconds = this.warningThreshold;

        // Update immediately
        timeRemainingSpan.textContent = remainingSeconds;

        // Update every second
        this.countdownInterval = setInterval(() => {
            remainingSeconds--;
            timeRemainingSpan.textContent = remainingSeconds;

            if (remainingSeconds <= 0) {
                // Time's up - token has expired
                clearInterval(this.countdownInterval);
                console.log('Token has expired, redirecting to login');
                window.location.href = '/login?expired=true';
            }
        }, 1000);
    }

    refreshToken() {
        console.log('Refreshing token by reloading current page...');

        // Clear intervals
        this.clearIntervals();

        // Simply reload the current page - the middleware will refresh the token automatically
        window.location.reload();
    }

    cancelRefresh() {
        console.log('User cancelled token refresh');

        // Clear intervals
        this.clearIntervals();

        // Hide modal
        this.modal.hide();

        // User chose not to refresh - token will expire naturally
        // The existing middleware will handle the redirect when token expires
    }

    clearIntervals() {
        if (this.countdownInterval) {
            clearInterval(this.countdownInterval);
            this.countdownInterval = null;
        }
        if (this.timeoutInterval) {
            clearTimeout(this.timeoutInterval);
            this.timeoutInterval = null;
        }
    }

    destroy() {
        this.clearIntervals();
        if (this.modal) {
            this.modal.dispose();
        }
    }
}

// Initialize token timeout manager when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get token expiration time from template context
    const tokenExpiresIn = {{ token_expires_in | default(0) }};

    // Only initialize on protected pages (where token_expires_in is provided)
    if (tokenExpiresIn > 0) {
        window.tokenTimeoutManager = new TokenTimeoutManager(tokenExpiresIn);
    }
});

// Clean up when page unloads
window.addEventListener('beforeunload', function() {
    if (window.tokenTimeoutManager) {
        window.tokenTimeoutManager.destroy();
    }
});
</script>

</body>
</html>